<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Lease Management</h1>
    <button (click)="addNewLease()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center">
      <span class="material-icons mr-1 text-sm">add</span> New Lease
    </button>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    {{ error }}
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg shadow mb-6 p-4">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <label for="filterText" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
        <input
          type="text"
          id="filterText"
          [(ngModel)]="filterText"
          (ngModelChange)="onFilterChange()"
          placeholder="Search by tenant, unit, or property"
          class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="md:w-1/4">
        <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select
          id="statusFilter"
          [(ngModel)]="statusFilter"
          (ngModelChange)="onFilterChange()"
          class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="all">All</option>
          <option value="Active">Active</option>
          <option value="Expired">Expired</option>
          <option value="Upcoming">Upcoming</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="flex justify-center items-center py-8">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <!-- Leases list -->
  <div *ngIf="!loading && filteredLeases.length > 0" class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property/Unit</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Rent</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <tr *ngFor="let lease of filteredLeases" class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">{{ lease.propertyName || 'Property' }}</div>
            <div class="text-sm text-gray-500">Unit: {{ lease.unitNumber || lease.unitId }}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">{{ lease.tenantName || 'Tenant #' + lease.tenantId }}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">{{ formatDate(lease.startDate) }} - {{ formatDate(lease.endDate) }}</div>
            <div *ngIf="lease.status === 'Active'" class="text-xs text-gray-500">
              {{ lease.daysRemaining }} days remaining
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">{{ formatCurrency(lease.monthlyRent) }}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span [ngClass]="{
              'px-2 py-1 text-xs font-semibold rounded-full': true,
              'bg-green-100 text-green-800': lease.status === 'Active',
              'bg-red-100 text-red-800': lease.status === 'Expired',
              'bg-yellow-100 text-yellow-800': lease.status === 'Upcoming'
            }">
              {{ lease.status }}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button (click)="viewLeaseDetails(lease)" class="text-blue-600 hover:text-blue-900 mr-3">
              <span class="material-icons text-sm">visibility</span>
            </button>
            <button (click)="editLease(lease)" class="text-yellow-600 hover:text-yellow-900 mr-3">
              <span class="material-icons text-sm">edit</span>
            </button>
            <button *ngIf="lease.status === 'Active'" (click)="terminateLease(lease)" class="text-red-600 hover:text-red-900">
              <span class="material-icons text-sm">cancel</span>
            </button>
            <button *ngIf="lease.status === 'Expired'" (click)="renewLease(lease)" class="text-green-600 hover:text-green-900">
              <span class="material-icons text-sm">autorenew</span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- No leases found -->
  <div *ngIf="!loading && filteredLeases.length === 0" class="bg-white rounded-lg shadow p-6 text-center">
    <p class="text-gray-500">No leases found matching your criteria.</p>
  </div>

  <!-- Add/Edit Lease Form Modal -->
  <div *ngIf="showLeaseForm" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-3xl shadow-lg overflow-auto max-h-[90vh]">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">{{ isEditMode ? 'Edit Lease' : 'Add New Lease' }}</h2>
          <button (click)="cancelLeaseForm()" class="text-gray-400 hover:text-gray-500">
            <span class="material-icons">close</span>
          </button>
        </div>

        <form [formGroup]="leaseForm" (ngSubmit)="submitLeaseForm()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Property Selection -->
            <div>
              <label for="propertyId" class="block text-sm font-medium text-gray-700 mb-1">Property</label>
              <select 
                id="propertyId" 
                formControlName="propertyId" 
                (change)="onPropertyChange()" 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select Property</option>
                <option *ngFor="let property of properties" [value]="property.id">{{ property.name }}</option>
              </select>
              <div *ngIf="leaseForm.get('propertyId')?.invalid && leaseForm.get('propertyId')?.touched" class="text-red-500 text-xs mt-1">
                Property is required
              </div>
            </div>

            <!-- Unit Selection -->
            <div>
              <label for="unitId" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
              <select 
                id="unitId" 
                formControlName="unitId" 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                [disabled]="!leaseForm.get('propertyId')?.value"
              >
                <option value="">Select Unit</option>
                <option *ngFor="let unit of availableUnits" [value]="unit.id">{{ unit.unitNumber }}</option>
              </select>
              <div *ngIf="leaseForm.get('unitId')?.invalid && leaseForm.get('unitId')?.touched" class="text-red-500 text-xs mt-1">
                Unit is required
              </div>
            </div>

            <!-- Tenant Selection -->
            <div>
              <label for="tenantId" class="block text-sm font-medium text-gray-700 mb-1">Tenant</label>
              <select 
                id="tenantId" 
                formControlName="tenantId" 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select Tenant</option>
                <option *ngFor="let tenant of tenants" [value]="tenant.id">{{ tenant.firstName }} {{ tenant.lastName }}</option>
              </select>
              <div *ngIf="leaseForm.get('tenantId')?.invalid && leaseForm.get('tenantId')?.touched" class="text-red-500 text-xs mt-1">
                Tenant is required
              </div>
            </div>

            <!-- Start Date -->
            <div>
              <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
              <input 
                type="date" 
                id="startDate" 
                formControlName="startDate" 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <div *ngIf="leaseForm.get('startDate')?.invalid && leaseForm.get('startDate')?.touched" class="text-red-500 text-xs mt-1">
                Start date is required
              </div>
            </div>

            <!-- End Date -->
            <div>
              <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
              <input 
                type="date" 
                id="endDate" 
                formControlName="endDate" 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <div *ngIf="leaseForm.get('endDate')?.invalid && leaseForm.get('endDate')?.touched" class="text-red-500 text-xs mt-1">
                End date is required
              </div>
              <div *ngIf="leaseForm.errors?.['endDateBeforeStart']" class="text-red-500 text-xs mt-1">
                End date must be after start date
              </div>
            </div>

            <!-- Monthly Rent -->
            <div>
              <label for="monthlyRent" class="block text-sm font-medium text-gray-700 mb-1">Monthly Rent ($)</label>
              <input 
                type="number" 
                id="monthlyRent" 
                formControlName="monthlyRent" 
                min="0"
                step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <div *ngIf="leaseForm.get('monthlyRent')?.invalid && leaseForm.get('monthlyRent')?.touched" class="text-red-500 text-xs mt-1">
                <span *ngIf="leaseForm.get('monthlyRent')?.errors?.['required']">Monthly rent is required</span>
                <span *ngIf="leaseForm.get('monthlyRent')?.errors?.['min']">Monthly rent must be greater than 0</span>
              </div>
            </div>

            <!-- Security Deposit -->
            <div>
              <label for="securityDeposit" class="block text-sm font-medium text-gray-700 mb-1">Security Deposit ($)</label>
              <input 
                type="number" 
                id="securityDeposit" 
                formControlName="securityDeposit" 
                min="0"
                step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <div *ngIf="leaseForm.get('securityDeposit')?.invalid && leaseForm.get('securityDeposit')?.touched" class="text-red-500 text-xs mt-1">
                <span *ngIf="leaseForm.get('securityDeposit')?.errors?.['required']">Security deposit is required</span>
                <span *ngIf="leaseForm.get('securityDeposit')?.errors?.['min']">Security deposit must be greater than or equal to 0</span>
              </div>
            </div>

            <!-- Is Active -->
            <div>
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="isActive" 
                  formControlName="isActive" 
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                >
                <label for="isActive" class="ml-2 block text-sm text-gray-700">Active Lease</label>
              </div>
              <p class="text-xs text-gray-500 mt-1">Uncheck this box for inactive leases</p>
            </div>
          </div>

          <!-- Form Buttons -->
          <div class="mt-8 flex justify-end space-x-3">
            <button 
              type="button" 
              (click)="cancelLeaseForm()" 
              class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Cancel
            </button>
            <button 
              type="submit" 
              [disabled]="leaseForm.invalid || formSubmitting" 
              class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed"
            >
              <span *ngIf="formSubmitting" class="inline-block animate-spin h-4 w-4 border-2 border-t-transparent border-white rounded-full mr-2"></span>
              {{ isEditMode ? 'Update' : 'Create' }} Lease
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Lease Details Sidebar -->
  <div *ngIf="showDetails && selectedLease" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-end z-40">
    <div class="bg-white w-full md:w-1/2 lg:w-1/3 h-full overflow-auto shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">Lease Details</h2>
        <button (click)="closeDetails()" class="text-gray-400 hover:text-gray-500">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="space-y-4">
        <!-- Property/Unit Information -->
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="text-lg font-medium mb-2">Property Information</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-sm font-medium text-gray-500">Property</p>
              <p>{{ selectedLease.propertyName || 'Property #' + selectedLease.propertyId }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Unit</p>
              <p>{{ selectedLease.unitNumber || 'Unit #' + selectedLease.unitId }}</p>
            </div>
          </div>
        </div>

        <!-- Tenant Information -->
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="text-lg font-medium mb-2">Tenant Information</h3>
          <p>{{ selectedLease.tenantName || 'Tenant #' + selectedLease.tenantId }}</p>
        </div>

        <!-- Lease Terms -->
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="text-lg font-medium mb-2">Lease Terms</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-sm font-medium text-gray-500">Start Date</p>
              <p>{{ formatDate(selectedLease.startDate) }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">End Date</p>
              <p>{{ formatDate(selectedLease.endDate) }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Monthly Rent</p>
              <p>{{ formatCurrency(selectedLease.monthlyRent) }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Security Deposit</p>
              <p>{{ formatCurrency(selectedLease.securityDeposit) }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Status</p>
              <p>
                <span [ngClass]="{
                  'px-2 py-1 text-xs font-semibold rounded-full': true,
                  'bg-green-100 text-green-800': selectedLease.status === 'Active',
                  'bg-red-100 text-red-800': selectedLease.status === 'Expired',
                  'bg-yellow-100 text-yellow-800': selectedLease.status === 'Upcoming'
                }">
                  {{ selectedLease.status }}
                </span>
              </p>
            </div>
            <div *ngIf="selectedLease.status === 'Active'">
              <p class="text-sm font-medium text-gray-500">Days Remaining</p>
              <p>{{ selectedLease.daysRemaining }}</p>
            </div>
          </div>
        </div>

        <!-- Payment History -->
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="text-lg font-medium mb-2">Payment History</h3>
          <div *ngIf="selectedLease.payments && selectedLease.payments.length > 0">
            <div *ngFor="let payment of selectedLease.payments" class="border-b py-2 last:border-b-0">
              <div class="flex justify-between">
                <span>{{ formatDate(payment.paymentDate) }}</span>
                <span class="font-medium">{{ formatCurrency(payment.amount) }}</span>
              </div>
              <p class="text-sm text-gray-500">{{ payment.description }}</p>
            </div>
          </div>
          <p *ngIf="!selectedLease.payments || selectedLease.payments.length === 0" class="text-gray-500 text-sm">
            No payment records found.
          </p>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mt-6">
          <button (click)="editLease(selectedLease)" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
            Edit Lease
          </button>
          <button *ngIf="selectedLease.status === 'Active'" (click)="terminateLease(selectedLease)" 
            class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
            Terminate Lease
          </button>
          <button *ngIf="selectedLease.status === 'Expired'" (click)="renewLease(selectedLease)" 
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            Renew Lease
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
